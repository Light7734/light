kind: pipeline
type: docker
name: linux_amd64

platform:
  os: linux
  arch: amd64

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock

volumes:
- name: py
  temp: {}

services:
  - name: docker
    image: docker:dind
    privileged: true
    volumes:
      - name: dockersock
        path: /var/run/

steps:
  - name: setup_image
    image: docker:latest
    volumes:
    - name: dockersock
      path: /var/run/docker.sock
    commands:
      - until docker info; do echo "Waiting for Docker daemon..."; sleep 1; done
      - docker build -t ubuntu_amd64 -f ./tools/docker/linux_amd64 .

  - name: list_images
    image: docker:latest
    volumes:
    - name: dockersock
      path: /var/run/docker.sock
    commands:
      - docker images

  - name: setup_conan
    image: ubuntu_amd64:latest
    volumes:
    - name: py
      path: /opt/venv/
    pull: if-not-exists
    environment:
      CONAN_REVISIONS_ENABLED: "1"
    commands:
      - . /opt/venv/bin/activate
      - pip install conan==2.5.0

  - name: echo_info
    image: ubuntu_amd64:latest
    pull: if-not-exists
    volumes:
    - name: py
      path: /opt/venv/
    commands:
      - . /opt/venv/bin/activate
      - pip --version
      - python3 --version
      - conan --version
      - gcc --version
      - g++ --version
      - clang --version
      - clang++ --version
      - clang-tidy --version
      - clang-format --version

  - name: build_gcc
    image: ubuntu_amd64:latest
    pull: if-not-exists
    volumes:
    - name: py
      path: /opt/venv/
    commands:
      - rm -rv ./build
      - export CC=$(which gcc)
      - export CXX=$(which g++)

      - conan profile detect
      - cp ./tools/conan/profiles/linux_gcc_amd64 $(conan profile path default)
      - conan install . --build=missing
      - conan build .

      - ./build/Release/modules/light/light

  - name: build_clang
    image: ubuntu_amd64:latest
    pull: if-not-exists
    volumes:
    - name: py
      path: /opt/venv/
    commands:
      - rm -rv ./build
      - export CC=$(which clang)
      - export CXX=$(which clang++)

      - conan profile detect
      - cp ./tools/conan/profiles/linux_clang_amd64 $(conan profile path default)
      - conan install . --build=missing
      - conan build .

      - ./build/Release/modules/light/light

  - name: static_analysis
    image: ubuntu_amd64:latest
    pull: if-not-exists
    commands:
      - echo "[TODO] Implement static analysis"

  - name: run_tests
    image: ubuntu_amd64:latest
    pull: if-not-exists
    commands:
      - echp "[TODO] Implement tests"
      - ./build/Release/modules/light/light

  - name: report_coverage
    image: ubuntu_amd64:latest
    pull: if-not-exists
    commands:
      - echp "[TODO] Implement coverage report"
